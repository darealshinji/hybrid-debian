bin_dir="$HOME/.hybrid-bin"
hybrid="$bin_dir/Hybrid-$QT"
URL=http://www.selur.de/sites/default/files/hybrid_downloads
install_hybrid="$prefix/share/hybrid-common/install-hybrid.sh"


# Get version strings
if [ -f "$hybrid" ] ; then
    current_ver=$("$hybrid" -version | cut -d' ' -f3)
else
    current_ver=0
fi
current_ver_np=$(echo $current_ver | sed -e 's/\.//g')
available_ver=$(wget -q -O - $URL/version.txt)
available_ver_np=$(echo $available_ver | sed -e 's/\.//g')


# Check for updates
if [ -f "$hybrid" ] ; then
    if [ -z $available_ver ] ; then
        echo "Couldn't get the version string of the current release."
        echo "Are you connected to the Internet?"
    elif [ $available_ver_np -gt $current_ver_np ] ; then
        xterm -title "Update Hybrid (Qt $QT) to rev $available_ver" -e "$install_hybrid" $QT
    fi
else
    xterm -title "Install Hybrid (Qt $QT) rev $available_ver" -e "$install_hybrid" $QT
fi


# Temporary solution to successfully detect bdsup2sub++
if [ ! -z "$(which bdsup2sub++)" ] ; then
    ln -fs "$(which bdsup2sub++)" "$bin_dir/bdsup2sub++"
else
    # Delete '~/.hybrid-bin/bdsup2sub++' if it's a dead link
    checklink=$(find -L "$bin_dir" -type l -name bdsup2sub++)
    if [ ! -z "$checklink" ] ; then
        rm -f "$checklink"
    fi

    # Check for Java and install BDSup2Sub.jar
    BDSup2Sub=BDSup2Sub.jar
    # version 5.1.2
    BDSup2Sub_URL=http://dl.dropbox.com/u/18208597/BDSup2Sub/downloads
    if [ ! -z "$(which java)" ] ; then
        if [ ! -f "$bin_dir/$BDSup2Sub" ] ; then
            mkdir -p "$bin_dir"
            cd "$bin_dir"

         # check if BDSup2Sub.jar is available
            wget -q --spider $BDSup2Sub_URL/$BDSup2Sub

            if [ $? = 0 ] ; then
                xterm -title "Download BDSup2Sub.jar" -e "wget $BDSup2Sub_URL/$BDSup2Sub"
            fi
        fi
    else
        echo "No Java found (required by BDSup2Sub)"
    fi
fi


# Check for AviSynth extension
avs_extension_path="$prefix/share/hybrid-avisynth-extension"

if [ -d "$avs_extension_path" ] ; then
    avs_install_script="$avs_extension_path/install-hybrid-avisynth-extension.sh"
    avs_version_file="$bin_dir/avisynthPlugins/version"
    avs_pkg_version=$(cat "$avs_extension_path/version")

    if [ -f "$avs_version_file" ] ; then
        avs_version=$(cat "$avs_version_file")
        avs_title="Update AviSynth extension"
    else
        avs_version=0
        avs_title="Install AviSynth extension"
    fi

    # Install/Update AviSynth extension
    if [ $avs_pkg_version -gt $avs_version ] ; then
        xterm -title "$avs_title" -e "$avs_install_script"
    fi

    if [ ! -f "$HOME/.hybrid/misc.ini" ] ; then
        mkdir -p "$HOME/.hybrid"
        cat >> "$HOME/.hybrid/misc.ini" << EOF
[General]
avisynthOnLinux=true
avisynthExtensionPath="$bin_dir/avisynthPlugins"
EOF
    fi

    system32="$HOME/.wine/drive_c/windows/system32"
    syswow64="$HOME/.wine/drive_c/windows/syswow64"
    mkdir -p "$system32" "$syswow64"
    test -f "$system32/avisynth.dll" || ln -rs "$bin_dir/avisynth.dll" "$system32/avisynth.dll"
    test -f "$syswow64/avisynth.dll" || ln -rs "$bin_dir/avisynth.dll" "$syswow64/avisynth.dll"
    test -f "$system32/DevIL.dll" || ln -rs "$bin_dir/avisynth.dll" "$system32/DevIL.dll"
    test -f "$syswow64/DevIL.dll" || ln -rs "$bin_dir/avisynth.dll" "$syswow64/DevIL.dll"
fi


# check if DE is KDE
# if we're using Qt5 Hybrid and we're not on KDE,
# then run the app with '-style=gtk'
xprop -name "kwin" >/dev/null 2>&1
if [ $(echo $?) = 1 ] && [ $QT = 521 ] ; then
  gtk_style='-style=gtk'
fi


# start Hybrid
if [ "$log" = "enabled" ] ; then
  mkdir -p "$HOME/.hybrid/logs"
  date=$(date +"%Y-%m-%d_%H-%M-%S")
  "$hybrid" $gtk_style "$@" | tee "$HOME/.hybrid/logs/hybrid-qt$QT-$date.log" &
else
  "$hybrid" $gtk_style "$@" &
fi
