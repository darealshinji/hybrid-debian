hybrid="$bin/Hybrid-$QT"
url="http://www.selur.de/sites/default/files/hybrid_downloads"
install_hybrid="$prefix/share/hybrid-common/install-hybrid.sh"

avs_version_url="https://raw.githubusercontent.com/darealshinji/hybrid-debian/avisynth-extension/version"
avs_extension_path="$bin/avisynth"
avs_install_script="$prefix/share/hybrid-avisynth-extension/install-hybrid-avisynth-extension.sh"


# Get version strings
if [ -f "$hybrid" ] ; then
    current_ver=$("$hybrid" -version | cut -d' ' -f3)
else
    current_ver=0
fi
current_ver_np=$(echo $current_ver | tr -d .)
available_ver=$(wget -q -O - $url/version.txt)
available_ver_np=$(echo $available_ver | tr -d .)


# Roll back to previous release version
if [ "$rollback" = "yes" ] ; then
    if [ -f "$hybrid.old" ] ; then
        cd "$bin"
        mv -f "Hybrid-$QT.old" "Hybrid-$QT"
        chmod 0755 Hybrid-$QT
        current_ver=$("$hybrid" -version | cut -d' ' -f3)
        echo "Switched back to Hybrid version $current_ver"
        touch "$bin/.disable-updates"
        echo "automatic updates: DISABLED"
        exit 0
    else
        echo "No previous version available as backup."
        exit 1
    fi
fi


# Check for updates
do_install_hybrid="no"
if [ -f "$hybrid" ] ; then
    test -f "$bin/.disable-updates" && update="disabled"
    if [ "$update" = "enabled" ] ; then
        if [ -z $available_ver ] ; then
            echo "Couldn't get the version string of the current release."
            echo "Are you connected to the Internet?"
        elif [ $available_ver_np -gt $current_ver_np ] ; then
            do_install_hybrid="yes"
            install_hybrid_title="Update Hybrid (Qt $QT) to rev $available_ver"
        fi
    fi
else
    do_install_hybrid="yes"
    install_hybrid_title="Install Hybrid (Qt $QT) rev $available_ver"
fi
if [ "$do_install_hybrid" = "yes" ] ; then
    "$install_hybrid" $QT | zenity \
        --progress --pulsate --auto-close --no-cancel \
        --width=550 \
        --title="$install_hybrid_title" \
        --text="Wait a few seconds until the donwload is finished ..."
fi


# Check for AviSynth extension
if [ -f "$avs_install_script" ] ; then
    avs_available_ver=$(wget -O - $avs_version_url)

    if [ -z $avs_available_ver ] ; then
        echo "Couldn't get the version string of the latest AviSynth extension."
        echo "Are you connected to the Internet?"
    else
        if [ -f "$avs_extension_path/version" ] ; then
            avs_current_ver=$(cat "$avs_extension_path/version")
            avs_title="Update AviSynth extension"
        else
            avs_current_ver=0
            avs_title="Install AviSynth extension"
        fi

        # Install/Update AviSynth extension
        if [ $avs_available_ver -gt $avs_current_ver ] ; then
            "$avs_install_script" $avs_available_ver | zenity \
                    --progress --pulsate --auto-close --no-cancel \
                    --width=550 \
                    --title="$avs_title" \
                    --text="Wait a few seconds until the donwload is finished ..."
        fi

        if [ ! -f "$HOME/.hybrid/misc.ini" ] ; then
            mkdir -p "$HOME/.hybrid"
            cat > "$HOME/.hybrid/misc.ini" << EOF
[General]
avisynthOnLinux=true
avisynthExtensionPath="$avs_extension_path/avisynthPlugins"
EOF
        fi

        system32="$HOME/.wine/drive_c/windows/system32"
        syswow64="$HOME/.wine/drive_c/windows/syswow64"
        mkdir -p "$system32" "$syswow64"
        test -f "$system32/avisynth.dll" || ln -rs "$bin/avisynth/avisynth.dll" "$system32/avisynth.dll"
        test -f "$syswow64/avisynth.dll" || ln -rs "$bin/avisynth/avisynth.dll" "$syswow64/avisynth.dll"
    fi
else
    rm -rf "$bin/avisynth"
    if [ -f "$HOME/.hybrid/misc.ini" ] ; then
        sed -i "s/^avisynthOnLinux=true/^avisynthOnLinux=false/;" "$HOME/.hybrid/misc.ini"
    fi
fi


# check if DE is KDE
# if we're using Qt5 Hybrid and we're not on KDE,
# then run the app with '-style=gtk'
xprop -name "kwin" >/dev/null 2>&1
if [ $(echo $?) = 1 ] && [ $QT = 521 ] ; then
    gtk_style='-style=gtk'
fi


# start Hybrid
if [ "$print_version" = "yes" ] ; then
    "$hybrid" -version
    exit 0
fi
if [ "$log" = "enabled" ] ; then
    mkdir -p "$HOME/.hybrid/logs"
    date=$(date +"%Y-%m-%d_%H-%M-%S")
    "$hybrid" $gtk_style "$@" | tee "$HOME/.hybrid/logs/hybrid-qt$QT-$date.log"
else
    "$hybrid" $gtk_style "$@"
fi
